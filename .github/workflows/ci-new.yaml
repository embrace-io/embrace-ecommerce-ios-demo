name: Onboarding - Generate Demo Sessions

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 */2 * * *'  # Run every 2 hours

env:
  PROJECT_NAME: "Embrace Ecommerce"
  NUM_DEVICES: 10

jobs:
  onboarding-demo:
    runs-on: macos-latest
    timeout-minutes: 119

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Configure App with Repository Variables
      run: |
        echo "üîß Configuring app with repository variables..."
        # Check if APP_ID variable exists
        if [[ -n "${{ vars.APP_ID }}" ]]; then
          echo "‚úÖ APP_ID found in repository variables: ${{ vars.APP_ID }}"
          # Update the SDK configuration file
          echo "üìù Updating SDKConfiguration.swift..."
          sed -i '' 's/static let appId = "YOUR_EMBRACE_APP_ID"/static let appId = "${{ vars.APP_ID }}"/' "Embrace Ecommerce/Services/SDKConfiguration.swift"
          echo "‚úÖ Updated SDK configuration"
          # Show the updated line for verification
          echo "üìã Updated line:"
          grep -n "static let appId" "Embrace Ecommerce/Services/SDKConfiguration.swift" || echo "‚ö†Ô∏è Could not find appId line"
        else
          echo "‚ùå ERROR: APP_ID variable not found in repository variables"
          echo "   Please add APP_ID as a repository variable before running this workflow."
          echo "   Go to Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Variables tab"
          exit 1
        fi
        echo ""

        # Set RUN_SOURCE to ci_action
        echo "üìù Configuring UITest to use ci_action as RUN_SOURCE..."
        sed -i '' 's/"RUN_SOURCE": "[^"]*"/"RUN_SOURCE": "ci_action"/' "Embrace EcommerceUITests/Embrace_EcommerceUITests.swift"
        echo "‚úÖ RUN_SOURCE set to ci_action"
        echo ""

    - name: Set up Xcode
      run: |
        sudo xcode-select --print-path

    - name: Environment Information
      run: |
        echo "üîß ENVIRONMENT INFORMATION"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "üñ•Ô∏è  Runner OS: ${{ runner.os }}"
        echo "üìÖ Date: $(date)"
        echo "üõ†Ô∏è  Xcode Version: $(xcodebuild -version | head -1)"
        echo "üì± Available SDK versions:"
        xcodebuild -showsdks | grep iOS || echo "No iOS SDKs found"
        echo "üîç Simulator runtimes:"
        xcrun simctl list runtimes | grep iOS || echo "No iOS runtimes found"
        echo "üî¢ Number of devices to test: ${{ env.NUM_DEVICES }}"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo ""

    - name: Cache DerivedData, SPM dependencies, and SwiftPM
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/Library/Caches/org.swift.swiftpm
          ~/.swiftpm
        key: ${{ runner.os }}-xcode-cache-${{ hashFiles('**/Project.xcodeproj/project.pbxproj', '**/Package.resolved', '**/*.swift') }}
        restore-keys: |
          ${{ runner.os }}-xcode-cache-

    - name: Resolve Swift Package dependencies
      run: |
        echo "üì¶ Resolving Swift Package dependencies..."
        xcodebuild -resolvePackageDependencies \
          -scheme "${{ env.PROJECT_NAME }}" \
          -derivedDataPath ~/Library/Developer/Xcode/DerivedData || {
          echo "‚ùå ERROR: Failed to resolve Swift Package dependencies"
          exit 1
        }
        echo "‚úÖ Swift Package dependencies resolved"
        echo ""

    - name: Prepare Environment
      run: |
        echo "================================================"
        echo "üìã Prepare Environment"
        echo "================================================"
        echo ""
        echo "Cleaning up any existing simulators..."
        killall Simulator 2>/dev/null || true
        xcrun simctl shutdown all 2>/dev/null || true
        echo "‚úÖ Simulators cleaned up"

    - name: Find Base Simulator
      id: find_simulator
      run: |
        echo "üîç Finding valid iPhone simulator..."
        PROJECT_NAME="${{ env.PROJECT_NAME }}"
        SCHEME="${{ env.PROJECT_NAME }}"
        SIMULATOR="iPhone 16 Pro"

        # Get valid destination from xcodebuild
        DESTINATION_LINE=$(xcodebuild -showdestinations -project "$PROJECT_NAME.xcodeproj" -scheme "$SCHEME" 2>&1 | grep "iPhone 16 Pro" | grep -v "Max" | head -1)

        if [[ -z "$DESTINATION_LINE" ]]; then
          echo "‚ö†Ô∏è iPhone 16 Pro not found, trying any iPhone..."
          DESTINATION_LINE=$(xcodebuild -showdestinations -project "$PROJECT_NAME.xcodeproj" -scheme "$SCHEME" 2>&1 | grep "iPhone" | grep "platform:iOS Simulator" | head -1)
        fi

        if [[ -z "$DESTINATION_LINE" ]]; then
          echo "‚ùå No iPhone simulator found"
          exit 1
        fi

        # Extract the ID from the destination line
        SIMULATOR_UDID=$(echo "$DESTINATION_LINE" | grep -o 'id:[A-F0-9-]*' | cut -d: -f2)

        if [[ -z "$SIMULATOR_UDID" ]]; then
          echo "‚ùå Could not extract simulator ID"
          exit 1
        fi

        echo "‚úÖ Found base simulator with ID: $SIMULATOR_UDID"
        echo "simulator_udid=$SIMULATOR_UDID" >> $GITHUB_OUTPUT

        # Extract device type and runtime from the base simulator
        echo "üîç Extracting device type and runtime information..."

        DEVICE_INFO=$(xcrun simctl list devices -j | python3 <<EOF
        import sys, json
        data = json.load(sys.stdin)
        target_udid = "$SIMULATOR_UDID"
        for runtime, devices in data["devices"].items():
            for device in devices:
                if device["udid"] == target_udid:
                    print(device["deviceTypeIdentifier"])
                    print(runtime)
                    sys.exit(0)
        EOF
        )

        DEVICE_TYPE=$(echo "$DEVICE_INFO" | awk 'NR==1')
        RUNTIME=$(echo "$DEVICE_INFO" | awk 'NR==2')

        if [[ -z "$DEVICE_TYPE" || -z "$RUNTIME" ]]; then
          echo "‚ùå Could not extract device type or runtime"
          exit 1
        fi

        echo "‚úÖ Device Type: $DEVICE_TYPE"
        echo "‚úÖ Runtime: $RUNTIME"
        echo "device_type=$DEVICE_TYPE" >> $GITHUB_OUTPUT
        echo "runtime=$RUNTIME" >> $GITHUB_OUTPUT

    - name: Create Simulator Clones
      id: create_clones
      run: |
        NUM_CLONES="${{ env.NUM_DEVICES }}"
        DEVICE_TYPE="${{ steps.find_simulator.outputs.device_type }}"
        RUNTIME="${{ steps.find_simulator.outputs.runtime }}"
        SIMULATOR="iPhone 16 Pro"

        echo "================================================"
        echo "üìã Creating $NUM_CLONES fresh simulator instances..."
        echo "üí° Note: Using 'create' instead of 'clone' ensures each simulator gets a unique IDFV"
        echo "================================================"

        # Array to store clone UDIDs
        CLONE_UDIDS=""

        for i in $(seq 1 $NUM_CLONES); do
          CLONE_NAME="${SIMULATOR}_Clone_${i}"

          echo "  Creating simulator $i: $CLONE_NAME"

          # Create a fresh simulator (not a clone) so each gets a unique IDFV
          CLONE_UDID=$(xcrun simctl create "$CLONE_NAME" "$DEVICE_TYPE" "$RUNTIME" 2>&1)

          if [[ -z "$CLONE_UDID" ]]; then
            echo "  ‚ùå Failed to create simulator $i"
            exit 1
          fi

          # Add to list (comma-separated)
          if [[ -z "$CLONE_UDIDS" ]]; then
            CLONE_UDIDS="$CLONE_UDID"
          else
            CLONE_UDIDS="$CLONE_UDIDS,$CLONE_UDID"
          fi

          echo "  ‚úÖ Simulator $i created: $CLONE_UDID"
        done

        echo "‚úÖ All $NUM_CLONES simulators created successfully"
        echo "clone_udids=$CLONE_UDIDS" >> $GITHUB_OUTPUT
        echo "num_clones=$NUM_CLONES" >> $GITHUB_OUTPUT

    - name: Build for Testing
      run: |
        echo "================================================"
        echo "üìã Build the Demo App"
        echo "================================================"
        echo ""

        # Get first clone UDID
        CLONE_UDIDS="${{ steps.create_clones.outputs.clone_udids }}"
        FIRST_CLONE=$(echo "$CLONE_UDIDS" | cut -d',' -f1)

        echo "Starting up the first device..."
        xcrun simctl boot "$FIRST_CLONE" 2>/dev/null || echo "  Already booted or failed"
        echo "‚è≥ Waiting for device to be ready..."
        xcrun simctl bootstatus "$FIRST_CLONE" -b > /dev/null 2>&1 || true
        echo "‚úÖ Device is ready"
        echo ""

        echo "Building the app with Embrace SDK..."
        echo "(This takes a few minutes - we only need to do this once)"
        echo ""

        xcodebuild build-for-testing \
          -project "${{ env.PROJECT_NAME }}.xcodeproj" \
          -scheme "${{ env.PROJECT_NAME }}" \
          -destination "platform=iOS Simulator,id=$FIRST_CLONE" \
          -configuration Debug \
          -enableCodeCoverage NO \
          -allowProvisioningUpdates \
          -skipMacroValidation \
          -derivedDataPath ~/Library/Developer/Xcode/DerivedData \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

        echo "‚úÖ Build completed successfully"

    - name: Run UI Tests on Each Simulator
      run: |
        echo "================================================"
        echo "üìã Run Tests on Each Device"
        echo "================================================"
        echo ""

        CLONE_UDIDS="${{ steps.create_clones.outputs.clone_udids }}"
        NUM_CLONES="${{ steps.create_clones.outputs.num_clones }}"
        PROJECT_NAME="${{ env.PROJECT_NAME }}"
        SCHEME="${{ env.PROJECT_NAME }}"
        TEST_CLASS="Embrace_EcommerceUITests"
        TEST_METHOD="testFlow"

        # Convert comma-separated string to array
        IFS=',' read -ra CLONE_ARRAY <<< "$CLONE_UDIDS"

        FAILED_COUNT=0

        # Run tests sequentially on each clone
        for i in "${!CLONE_ARRAY[@]}"; do
          clone_udid="${CLONE_ARRAY[$i]}"
          clone_num=$((i + 1))

          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üì± Device $clone_num of $NUM_CLONES"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

          # Boot this simulator (if not the first one which is already booted from build step)
          if [[ $i -gt 0 ]]; then
            echo "‚è≥ Starting device..."
            xcrun simctl boot "$clone_udid" 2>/dev/null || echo "  Already booted or failed"
            xcrun simctl bootstatus "$clone_udid" -b > /dev/null 2>&1 || true
          fi

          echo "üß™ Running demo test (this takes about 1-2 minutes)..."

          # Run test synchronously with isolated result bundle
          if xcodebuild test-without-building \
            -project "$PROJECT_NAME.xcodeproj" \
            -scheme "$SCHEME" \
            -destination "platform=iOS Simulator,id=$clone_udid" \
            -only-testing:"Embrace EcommerceUITests/$TEST_CLASS/$TEST_METHOD" \
            -parallel-testing-enabled NO \
            -derivedDataPath ~/Library/Developer/Xcode/DerivedData \
            -resultBundlePath "test_results_clone_${clone_num}.xcresult" \
            2>&1 | tee "test_output_clone_${clone_num}.log" | grep --line-buffered -E "(Test Suite|Test Case|passed|failed|Testing started|Testing cancelled)" || true; then
            echo "  ‚úÖ Clone $clone_num test completed successfully"
          else
            TEST_EXIT_CODE=${PIPESTATUS[0]}
            echo "  ‚ö†Ô∏è  Clone $clone_num test failed (exit code: $TEST_EXIT_CODE)"
            FAILED_COUNT=$((FAILED_COUNT + 1))
          fi

          # Shutdown and delete this clone before starting the next one
          echo "  üßπ Shutting down and deleting clone $clone_num..."
          xcrun simctl shutdown "$clone_udid" 2>/dev/null || true
          xcrun simctl delete "$clone_udid" 2>/dev/null || echo "  ‚ö†Ô∏è  Failed to delete clone $clone_num"

          echo "  ‚úÖ Clone $clone_num cleaned up"
        done

        echo "================================================"
        if [[ $FAILED_COUNT -eq 0 ]]; then
          echo "‚úÖ All tests completed successfully"
        else
          echo "‚ö†Ô∏è  $FAILED_COUNT out of $NUM_CLONES tests failed"
        fi
        echo "================================================"

    - name: Test Results Summary
      if: always()
      run: |
        echo ""
        echo "================================================"
        echo "üìä Test Results Summary"
        echo "================================================"
        echo ""

        NUM_CLONES="${{ steps.create_clones.outputs.num_clones }}"

        for i in $(seq 1 $NUM_CLONES); do
          log_file="test_output_clone_${i}.log"
          if [[ -f "$log_file" ]]; then
            if grep -q "Test Suite.*passed" "$log_file"; then
              echo "‚úÖ Clone $i: PASSED"
            elif grep -q "Test Suite.*failed" "$log_file"; then
              echo "‚ùå Clone $i: FAILED"
            else
              echo "‚ö†Ô∏è  Clone $i: UNKNOWN"
            fi
          else
            echo "‚ö†Ô∏è  Clone $i: No log file"
          fi
        done

        echo ""
        echo "================================================"

    - name: Final Cleanup
      if: always()
      run: |
        echo ""
        echo "üßπ Final cleanup..."

        # Cleanup result bundles and test logs
        echo "üßπ Cleaning up result bundles and test logs..."
        rm -rf test_results_clone_*.xcresult 2>/dev/null || true
        rm -f test_output_clone_*.log 2>/dev/null || true
        echo "‚úÖ Result bundles and test logs cleaned up"

        # Cleanup any remaining clones
        CLONE_UDIDS="${{ steps.create_clones.outputs.clone_udids }}"
        IFS=',' read -ra CLONE_ARRAY <<< "$CLONE_UDIDS"

        for clone_udid in "${CLONE_ARRAY[@]}"; do
          if xcrun simctl list devices | grep -q "$clone_udid"; then
            echo "  Found remaining clone, deleting..."
            xcrun simctl shutdown "$clone_udid" 2>/dev/null || true
            xcrun simctl delete "$clone_udid" 2>/dev/null || true
          fi
        done

        # Final cleanup: Kill all simulator processes
        echo "üßπ Stopping all Simulator processes..."
        killall Simulator 2>/dev/null || true
        xcrun simctl shutdown all 2>/dev/null || true
        echo "‚úÖ All Simulator processes stopped"
        echo "‚úÖ Cleanup complete"
