name: Scheduled Tests (Lightweight)

# Runs every 2 hours to maintain steady session flow to dashboard
# Creates non-stitched sessions (1 session per device) to complement
# one-simulator.yml which creates stitched sessions
on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

env:
  PROJECT_NAME: "Embrace Ecommerce"
  SCHEME_NAME: "Embrace Ecommerce"
  XCODE_VERSION: "16.4"
  DEVICE_NAME: "iPhone 16"

concurrency:
  group: scheduled-tests
  cancel-in-progress: true

jobs:
  run-tests:
    name: "${{ matrix.test_suite.name }}"
    runs-on: macos-latest
    timeout-minutes: 35

    strategy:
      fail-fast: false
      matrix:
        test_suite:
          # Single test to create 1 non-stitched timeline per run
          # Combined with one-simulator.yml (1 stitched timeline per run)
          # this achieves ~50% stitched / 50% non-stitched sessions
          - name: "Browse Products"
            target: "Embrace EcommerceUITests/Embrace_EcommerceUITests/testBrowseFlow"
            run_source: "scheduled-browse"

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app
          xcodebuild -version

      - name: Download build artifacts
        id: check_artifacts
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Attempting to download artifacts from build.yml workflow..."

          # Get the latest successful build.yml run
          RUN_ID=$(gh run list --workflow=build.yml --status=success --limit=1 --json databaseId --jq '.[0].databaseId' 2>/dev/null || echo "")

          if [[ -n "$RUN_ID" ]]; then
            echo "Found successful build run: $RUN_ID"
            mkdir -p DerivedData/Build/Products
            gh run download "$RUN_ID" --name test-build-artifacts --dir DerivedData/Build/Products 2>/dev/null || true
          fi

          # Check if artifacts were downloaded
          if [[ -d "DerivedData/Build/Products" ]] && [[ -n "$(ls -A DerivedData/Build/Products 2>/dev/null)" ]]; then
            echo "artifacts_found=true" >> $GITHUB_OUTPUT
            echo "Artifacts downloaded successfully"
            ls -la DerivedData/Build/Products/
          else
            echo "artifacts_found=false" >> $GITHUB_OUTPUT
            echo "No artifacts found, will build from source"
          fi

      - name: Configure Embrace App ID
        run: |
          if [[ -n "${{ vars.APP_ID }}" ]]; then
            sed -i '' 's/static let appId = "YOUR_EMBRACE_APP_ID"/static let appId = "${{ vars.APP_ID }}"/' "${{ env.PROJECT_NAME }}/Services/SDKConfiguration.swift"
            echo "Embrace APP_ID configured"
          else
            echo "ERROR: APP_ID variable not found"
            exit 1
          fi

      - name: Configure RUN_SOURCE
        run: |
          sed -i '' 's/"RUN_SOURCE": "[^"]*"/"RUN_SOURCE": "${{ matrix.test_suite.run_source }}"/' "${{ env.PROJECT_NAME }}UITests/Embrace_EcommerceUITests.swift"
          echo "RUN_SOURCE set to ${{ matrix.test_suite.run_source }}"

      - name: Setup simulator
        id: setup_simulator
        run: |
          SIMULATOR_UDID=$(xcrun simctl list devices available | grep "${{ env.DEVICE_NAME }}" | grep -v "Plus\|Pro" | head -1 | grep -o '[A-F0-9-]\{36\}')
          if [[ -z "$SIMULATOR_UDID" ]]; then
            echo "Simulator not found, trying any iPhone"
            SIMULATOR_UDID=$(xcrun simctl list devices available | grep "iPhone" | head -1 | grep -o '[A-F0-9-]\{36\}')
          fi
          echo "simulator_udid=$SIMULATOR_UDID" >> $GITHUB_OUTPUT
          echo "Found simulator: $SIMULATOR_UDID"

          xcrun simctl boot "$SIMULATOR_UDID" 2>/dev/null || true
          xcrun simctl bootstatus "$SIMULATOR_UDID" -b
          echo "Simulator booted"

      - name: Build for testing (fallback if no artifacts)
        if: steps.check_artifacts.outputs.artifacts_found != 'true'
        run: |
          echo "Building from source (no cached artifacts available)"
          xcodebuild build-for-testing \
            -project "${{ env.PROJECT_NAME }}.xcodeproj" \
            -scheme "${{ env.SCHEME_NAME }}" \
            -destination "platform=iOS Simulator,id=${{ steps.setup_simulator.outputs.simulator_udid }}" \
            -derivedDataPath "DerivedData" \
            -configuration Debug \
            -skipMacroValidation \
            -allowProvisioningUpdates \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            DEBUG_INFORMATION_FORMAT=dwarf-with-dsym

      - name: Upload dSYMs to Embrace (fallback build only)
        if: steps.check_artifacts.outputs.artifacts_found != 'true'
        env:
          EMBRACE_APP: ${{ vars.APP_ID }}
          EMBRACE_API_TOKEN: ${{ secrets.EMBRACE_API_TOKEN }}
        run: |
          curl -sL -o embrace_support.zip https://downloads.embrace.io/embrace_support.zip
          unzip -o embrace_support.zip
          chmod +x embrace_symbol_upload.darwin

          find "DerivedData/Build/Products" -type d -name "*.dSYM" -print0 | while IFS= read -r -d '' dsym_dir; do
            echo "Working on: ${dsym_dir}"
            find "${dsym_dir}/Contents/Resources/DWARF" -type f -print0 2>/dev/null | while IFS= read -r -d '' dwarf_file; do
              echo "Uploading: ${dwarf_file}"
              ./embrace_symbol_upload.darwin --dsym "${dwarf_file}" || echo "Warning: upload failed for ${dwarf_file}, continuing..."
            done
          done

      - name: Run test - ${{ matrix.test_suite.name }}
        run: |
          xcodebuild test-without-building \
            -project "${{ env.PROJECT_NAME }}.xcodeproj" \
            -scheme "${{ env.SCHEME_NAME }}" \
            -destination "platform=iOS Simulator,id=${{ steps.setup_simulator.outputs.simulator_udid }}" \
            -derivedDataPath "DerivedData" \
            -only-testing:"${{ matrix.test_suite.target }}" \
            -resultBundlePath "TestResults-${{ matrix.test_suite.run_source }}"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results-${{ matrix.test_suite.run_source }}
          path: TestResults-${{ matrix.test_suite.run_source }}.xcresult
          retention-days: 3
          if-no-files-found: ignore

      - name: Cleanup
        if: always()
        run: |
          killall Simulator 2>/dev/null || true
          xcrun simctl shutdown "${{ steps.setup_simulator.outputs.simulator_udid }}" 2>/dev/null || true
