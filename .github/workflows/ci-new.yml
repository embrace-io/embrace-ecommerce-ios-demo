name: Onboarding - Generate Demo Sessions

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */2 * * *'  # Run every 2 hours

env:
  PROJECT_NAME: "Embrace Ecommerce"
  NUM_DEVICES: 10

jobs:
  onboarding-demo:
    runs-on: macos-latest
    timeout-minutes: 119

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Configure App with Repository Variables
      run: |
        echo "ðŸ”§ Configuring app with repository variables..."
        # Check if APP_ID variable exists
        if [[ -n "${{ vars.APP_ID }}" ]]; then
          echo "âœ… APP_ID found in repository variables: ${{ vars.APP_ID }}"
          # Update the SDK configuration file
          echo "ðŸ“ Updating SDKConfiguration.swift..."
          sed -i '' 's/static let appId = "YOUR_EMBRACE_APP_ID"/static let appId = "${{ vars.APP_ID }}"/' "Embrace Ecommerce/Services/SDKConfiguration.swift"
          echo "âœ… Updated SDK configuration"
          # Show the updated line for verification
          echo "ðŸ“‹ Updated line:"
          grep -n "static let appId" "Embrace Ecommerce/Services/SDKConfiguration.swift" || echo "âš ï¸ Could not find appId line"
        else
          echo "âŒ ERROR: APP_ID variable not found in repository variables"
          echo "   Please add APP_ID as a repository variable before running this workflow."
          echo "   Go to Settings â†’ Secrets and variables â†’ Actions â†’ Variables tab"
          exit 1
        fi
        echo ""

        # Set RUN_SOURCE to ci_action
        echo "ðŸ“ Configuring UITest to use ci_action as RUN_SOURCE..."
        sed -i '' 's/"RUN_SOURCE": "[^"]*"/"RUN_SOURCE": "ci_action"/' "Embrace EcommerceUITests/Embrace_EcommerceUITests.swift"
        echo "âœ… RUN_SOURCE set to ci_action"
        echo ""

    - name: Set up Xcode
      run: |
        sudo xcode-select --print-path

    - name: Environment Information
      run: |
        echo "ðŸ”§ ENVIRONMENT INFORMATION"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ–¥ï¸  Runner OS: ${{ runner.os }}"
        echo "ðŸ“… Date: $(date)"
        echo "ðŸ› ï¸  Xcode Version: $(xcodebuild -version | head -1)"
        echo "ðŸ“± Available SDK versions:"
        xcodebuild -showsdks | grep iOS || echo "No iOS SDKs found"
        echo "ðŸ” Simulator runtimes:"
        xcrun simctl list runtimes | grep iOS || echo "No iOS runtimes found"
        echo "ðŸ”¢ Number of devices to test: ${{ env.NUM_DEVICES }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""

    - name: Cache DerivedData, SPM dependencies, and SwiftPM
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/Library/Caches/org.swift.swiftpm
          ~/.swiftpm
        key: ${{ runner.os }}-xcode-cache-${{ hashFiles('**/Project.xcodeproj/project.pbxproj', '**/Package.resolved', '**/*.swift') }}
        restore-keys: |
          ${{ runner.os }}-xcode-cache-

    - name: Resolve Swift Package dependencies
      run: |
        echo "ðŸ“¦ Resolving Swift Package dependencies..."
        xcodebuild -resolvePackageDependencies \
          -scheme "Embrace Ecommerce" \
          -derivedDataPath ~/Library/Developer/Xcode/DerivedData || {
          echo "âŒ ERROR: Failed to resolve Swift Package dependencies"
          exit 1
        }
        echo "âœ… Swift Package dependencies resolved"
        echo ""

    - name: Prepare Environment
      run: |
        echo "================================================"
        echo "ðŸ“‹ Prepare Environment"
        echo "================================================"
        echo ""
        echo "Cleaning up any existing simulators..."
        killall Simulator 2>/dev/null || true
        xcrun simctl shutdown all 2>/dev/null || true
        echo "âœ… Simulators cleaned up"

    - name: Find Base Simulator
      id: find_simulator
      run: |
        echo "ðŸ” Finding valid iPhone simulator..."
        PROJECT_NAME="Embrace Ecommerce"
        SCHEME="Embrace Ecommerce"
        SIMULATOR="iPhone 16 Pro"

        # Get valid destination from xcodebuild
        DESTINATION_LINE=$(xcodebuild -showdestinations -project "$PROJECT_NAME.xcodeproj" -scheme "$SCHEME" 2>&1 | grep "iPhone 16 Pro" | grep -v "Max" | head -1)

        if [[ -z "$DESTINATION_LINE" ]]; then
          echo "âš ï¸ iPhone 16 Pro not found, trying any iPhone..."
          DESTINATION_LINE=$(xcodebuild -showdestinations -project "$PROJECT_NAME.xcodeproj" -scheme "$SCHEME" 2>&1 | grep "iPhone" | grep "platform:iOS Simulator" | head -1)
        fi

        if [[ -z "$DESTINATION_LINE" ]]; then
          echo "âŒ No iPhone simulator found"
          exit 1
        fi

        # Extract the ID from the destination line
        SIMULATOR_UDID=$(echo "$DESTINATION_LINE" | grep -o 'id:[A-F0-9-]*' | cut -d: -f2)

        if [[ -z "$SIMULATOR_UDID" ]]; then
          echo "âŒ Could not extract simulator ID"
          exit 1
        fi

        echo "âœ… Found base simulator with ID: $SIMULATOR_UDID"
        echo "simulator_udid=$SIMULATOR_UDID" >> $GITHUB_OUTPUT

        # Extract device type and runtime from the base simulator
        echo "ðŸ” Extracting device type and runtime information..."

        DEVICE_INFO=$(xcrun simctl list devices -j | python3 -c "
import sys, json
data = json.load(sys.stdin)
target_udid = '$SIMULATOR_UDID'
for runtime, devices in data['devices'].items():
    for device in devices:
        if device['udid'] == target_udid:
            print(device['deviceTypeIdentifier'])
            print(runtime)
            sys.exit(0)
")

        DEVICE_TYPE=$(echo "$DEVICE_INFO" | sed -n '1p')
        RUNTIME=$(echo "$DEVICE_INFO" | sed -n '2p')

        if [[ -z "$DEVICE_TYPE" || -z "$RUNTIME" ]]; then
          echo "âŒ Could not extract device type or runtime"
          exit 1
        fi

        echo "âœ… Device Type: $DEVICE_TYPE"
        echo "âœ… Runtime: $RUNTIME"
        echo "device_type=$DEVICE_TYPE" >> $GITHUB_OUTPUT
        echo "runtime=$RUNTIME" >> $GITHUB_OUTPUT

    - name: Create Simulator Clones
      id: create_clones
      run: |
        NUM_CLONES="${{ env.NUM_DEVICES }}"
        DEVICE_TYPE="${{ steps.find_simulator.outputs.device_type }}"
        RUNTIME="${{ steps.find_simulator.outputs.runtime }}"
        SIMULATOR="iPhone 16 Pro"

        echo "================================================"
        echo "ðŸ“‹ Creating $NUM_CLONES fresh simulator instances..."
        echo "ðŸ’¡ Note: Using 'create' instead of 'clone' ensures each simulator gets a unique IDFV"
        echo "================================================"

        # Array to store clone UDIDs
        CLONE_UDIDS=""

        for i in $(seq 1 $NUM_CLONES); do
          CLONE_NAME="${SIMULATOR}_Clone_${i}"

          echo "  Creating simulator $i: $CLONE_NAME"

          # Create a fresh simulator (not a clone) so each gets a unique IDFV
          CLONE_UDID=$(xcrun simctl create "$CLONE_NAME" "$DEVICE_TYPE" "$RUNTIME" 2>&1)

          if [[ -z "$CLONE_UDID" ]]; then
            echo "  âŒ Failed to create simulator $i"
            exit 1
          fi

          # Add to list (comma-separated)
          if [[ -z "$CLONE_UDIDS" ]]; then
            CLONE_UDIDS="$CLONE_UDID"
          else
            CLONE_UDIDS="$CLONE_UDIDS,$CLONE_UDID"
          fi

          echo "  âœ… Simulator $i created: $CLONE_UDID"
        done

        echo "âœ… All $NUM_CLONES simulators created successfully"
        echo "clone_udids=$CLONE_UDIDS" >> $GITHUB_OUTPUT
        echo "num_clones=$NUM_CLONES" >> $GITHUB_OUTPUT

    - name: Build for Testing
      run: |
        echo "================================================"
        echo "ðŸ“‹ Build the Demo App"
        echo "================================================"
        echo ""

        # Get first clone UDID
        CLONE_UDIDS="${{ steps.create_clones.outputs.clone_udids }}"
        FIRST_CLONE=$(echo "$CLONE_UDIDS" | cut -d',' -f1)

        echo "Starting up the first device..."
        xcrun simctl boot "$FIRST_CLONE" 2>/dev/null || echo "  Already booted or failed"
        echo "â³ Waiting for device to be ready..."
        xcrun simctl bootstatus "$FIRST_CLONE" -b > /dev/null 2>&1 || true
        echo "âœ… Device is ready"
        echo ""

        echo "Building the app with Embrace SDK..."
        echo "(This takes a few minutes - we only need to do this once)"
        echo ""

        xcodebuild build-for-testing \
          -project "Embrace Ecommerce.xcodeproj" \
          -scheme "Embrace Ecommerce" \
          -destination "platform=iOS Simulator,id=$FIRST_CLONE" \
          -configuration Debug \
          -enableCodeCoverage NO \
          -allowProvisioningUpdates \
          -skipMacroValidation \
          -derivedDataPath ~/Library/Developer/Xcode/DerivedData \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

        echo "âœ… Build completed successfully"

    - name: Run UI Tests on Each Simulator
      run: |
        echo "================================================"
        echo "ðŸ“‹ Run Tests on Each Device"
        echo "================================================"
        echo ""

        CLONE_UDIDS="${{ steps.create_clones.outputs.clone_udids }}"
        NUM_CLONES="${{ steps.create_clones.outputs.num_clones }}"
        PROJECT_NAME="Embrace Ecommerce"
        SCHEME="Embrace Ecommerce"
        TEST_CLASS="Embrace_EcommerceUITests"
        TEST_METHOD="testFlow"

        # Convert comma-separated string to array
        IFS=',' read -ra CLONE_ARRAY <<< "$CLONE_UDIDS"

        FAILED_COUNT=0

        # Run tests sequentially on each clone
        for i in "${!CLONE_ARRAY[@]}"; do
          clone_udid="${CLONE_ARRAY[$i]}"
          clone_num=$((i + 1))

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“± Device $clone_num of $NUM_CLONES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Boot this simulator (if not the first one which is already booted from build step)
          if [[ $i -gt 0 ]]; then
            echo "â³ Starting device..."
            xcrun simctl boot "$clone_udid" 2>/dev/null || echo "  Already booted or failed"
            xcrun simctl bootstatus "$clone_udid" -b > /dev/null 2>&1 || true
          fi

          echo "ðŸ§ª Running demo test (this takes about 1-2 minutes)..."

          # Run test synchronously with isolated result bundle
          if xcodebuild test-without-building \
            -project "$PROJECT_NAME.xcodeproj" \
            -scheme "$SCHEME" \
            -destination "platform=iOS Simulator,id=$clone_udid" \
            -only-testing:"Embrace EcommerceUITests/$TEST_CLASS/$TEST_METHOD" \
            -parallel-testing-enabled NO \
            -derivedDataPath ~/Library/Developer/Xcode/DerivedData \
            -resultBundlePath "test_results_clone_${clone_num}.xcresult" \
            2>&1 | tee "test_output_clone_${clone_num}.log" | grep --line-buffered -E "(Test Suite|Test Case|passed|failed|Testing started|Testing cancelled)" || true; then
            echo "  âœ… Clone $clone_num test completed successfully"
          else
            TEST_EXIT_CODE=${PIPESTATUS[0]}
            echo "  âš ï¸  Clone $clone_num test failed (exit code: $TEST_EXIT_CODE)"
            FAILED_COUNT=$((FAILED_COUNT + 1))
          fi

          # Shutdown and delete this clone before starting the next one
          echo "  ðŸ§¹ Shutting down and deleting clone $clone_num..."
          xcrun simctl shutdown "$clone_udid" 2>/dev/null || true
          xcrun simctl delete "$clone_udid" 2>/dev/null || echo "  âš ï¸  Failed to delete clone $clone_num"

          echo "  âœ… Clone $clone_num cleaned up"
        done

        echo "================================================"
        if [[ $FAILED_COUNT -eq 0 ]]; then
          echo "âœ… All tests completed successfully"
        else
          echo "âš ï¸  $FAILED_COUNT out of $NUM_CLONES tests failed"
        fi
        echo "================================================"

    - name: Test Results Summary
      if: always()
      run: |
        echo ""
        echo "================================================"
        echo "ðŸ“Š Test Results Summary"
        echo "================================================"
        echo ""

        NUM_CLONES="${{ steps.create_clones.outputs.num_clones }}"

        for i in $(seq 1 $NUM_CLONES); do
          log_file="test_output_clone_${i}.log"
          if [[ -f "$log_file" ]]; then
            if grep -q "Test Suite.*passed" "$log_file"; then
              echo "âœ… Clone $i: PASSED"
            elif grep -q "Test Suite.*failed" "$log_file"; then
              echo "âŒ Clone $i: FAILED"
            else
              echo "âš ï¸  Clone $i: UNKNOWN"
            fi
          else
            echo "âš ï¸  Clone $i: No log file"
          fi
        done

        echo ""
        echo "================================================"

    - name: Final Cleanup
      if: always()
      run: |
        echo ""
        echo "ðŸ§¹ Final cleanup..."

        # Cleanup result bundles and test logs
        echo "ðŸ§¹ Cleaning up result bundles and test logs..."
        rm -rf test_results_clone_*.xcresult 2>/dev/null || true
        rm -f test_output_clone_*.log 2>/dev/null || true
        echo "âœ… Result bundles and test logs cleaned up"

        # Cleanup any remaining clones
        CLONE_UDIDS="${{ steps.create_clones.outputs.clone_udids }}"
        IFS=',' read -ra CLONE_ARRAY <<< "$CLONE_UDIDS"

        for clone_udid in "${CLONE_ARRAY[@]}"; do
          if xcrun simctl list devices | grep -q "$clone_udid"; then
            echo "  Found remaining clone, deleting..."
            xcrun simctl shutdown "$clone_udid" 2>/dev/null || true
            xcrun simctl delete "$clone_udid" 2>/dev/null || true
          fi
        done

        # Final cleanup: Kill all simulator processes
        echo "ðŸ§¹ Stopping all Simulator processes..."
        killall Simulator 2>/dev/null || true
        xcrun simctl shutdown all 2>/dev/null || true
        echo "âœ… All Simulator processes stopped"
        echo "âœ… Cleanup complete"
