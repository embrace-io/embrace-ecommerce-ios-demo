name: Xcode - Optimized CI

# Triggers: manual dispatch and optional scheduled runs
on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
  # Uncomment to run on a schedule (e.g., every 2 hours)
  # schedule:
  #   - cron: '0 */2 * * *'

env:
  PROJECT_NAME: "Embrace Ecommerce"
  SCHEME_NAME: "Embrace Ecommerce"

# Prevent multiple workflows from running simultaneously
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    timeout-minutes: 45
    runs-on: macos-latest

    strategy:
      fail-fast: false
      matrix:
        xcode_version: ["16.4"]
        device:
          - "iPhone 16"
          - "iPhone 16 Pro"
        test_suite:
          - name: "Authentication Guest Flow"
            target: "Embrace EcommerceUITests/Embrace_EcommerceUITests/testAuthenticationGuestFlow"
            run_source: "ci-optimized-auth"
          - name: "Main Flow"
            target: "Embrace EcommerceUITests/Embrace_EcommerceUITests/testFlow"
            run_source: "ci-optimized-flow"

    name: "${{ matrix.device }} - ${{ matrix.test_suite.name }}"

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Select Xcode version
      run: |
        sudo xcode-select -s /Applications/Xcode_${{ matrix.xcode_version }}.app
        xcodebuild -version
        swift --version

    - name: Setup simulator
      id: setup_simulator
      run: |
        # Boot the specified simulator
        SIMULATOR_UDID=$(xcrun simctl list devices available | grep "${{ matrix.device }}" | grep -v "unavailable" | head -1 | grep -o '[A-F0-9-]\{36\}')

        if [[ -z "$SIMULATOR_UDID" ]]; then
          echo "❌ Simulator '${{ matrix.device }}' not found"
          exit 1
        fi

        echo "simulator_udid=$SIMULATOR_UDID" >> $GITHUB_OUTPUT
        echo "✅ Found simulator: $SIMULATOR_UDID"

        # Boot simulator
        xcrun simctl boot "$SIMULATOR_UDID" 2>/dev/null || true
        xcrun simctl bootstatus "$SIMULATOR_UDID" -b
        echo "✅ Simulator booted"

    - name: Configure Embrace App ID
      run: |
        if [[ -n "${{ vars.APP_ID }}" ]]; then
          sed -i '' 's/static let appId = "YOUR_EMBRACE_APP_ID"/static let appId = "${{ vars.APP_ID }}"/' "${{ env.PROJECT_NAME }}/Services/SDKConfiguration.swift"
          echo "✅ Embrace APP_ID configured"
        else
          echo "❌ ERROR: APP_ID variable not found in repository variables"
          echo "Please add APP_ID to your repository variables at: Settings > Secrets and variables > Actions > Variables"
          exit 1
        fi

    - name: Configure test RUN_SOURCE
      run: |
        sed -i '' 's/"RUN_SOURCE": "[^"]*"/"RUN_SOURCE": "${{ matrix.test_suite.run_source }}"/' "${{ env.PROJECT_NAME }}UITests/Embrace_EcommerceUITests.swift"
        echo "✅ RUN_SOURCE set to ${{ matrix.test_suite.run_source }}"

    - name: Cache Swift Package Manager dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData/*/SourcePackages/checkouts
          .build
        key: ${{ runner.os }}-spm-${{ hashFiles('${{ env.PROJECT_NAME }}.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Install xcpretty
      run: |
        gem install xcpretty --no-document || echo "⚠️ xcpretty installation failed, will use raw output"

    - name: Build for testing
      run: |
        set -o pipefail
        xcodebuild build-for-testing \
          -project "${{ env.PROJECT_NAME }}.xcodeproj" \
          -scheme "${{ env.SCHEME_NAME }}" \
          -destination "platform=iOS Simulator,id=${{ steps.setup_simulator.outputs.simulator_udid }}" \
          -configuration Debug \
          -skipMacroValidation \
          -allowProvisioningUpdates \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          | xcpretty --color || xcodebuild build-for-testing \
          -project "${{ env.PROJECT_NAME }}.xcodeproj" \
          -scheme "${{ env.SCHEME_NAME }}" \
          -destination "platform=iOS Simulator,id=${{ steps.setup_simulator.outputs.simulator_udid }}" \
          -configuration Debug \
          -skipMacroValidation \
          -allowProvisioningUpdates \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

    - name: Run tests - ${{ matrix.test_suite.name }}
      run: |
        set -o pipefail
        xcodebuild test-without-building \
          -project "${{ env.PROJECT_NAME }}.xcodeproj" \
          -scheme "${{ env.SCHEME_NAME }}" \
          -destination "platform=iOS Simulator,id=${{ steps.setup_simulator.outputs.simulator_udid }}" \
          -only-testing:"${{ matrix.test_suite.target }}" \
          | xcpretty --color --test || xcodebuild test-without-building \
          -project "${{ env.PROJECT_NAME }}.xcodeproj" \
          -scheme "${{ env.SCHEME_NAME }}" \
          -destination "platform=iOS Simulator,id=${{ steps.setup_simulator.outputs.simulator_udid }}" \
          -only-testing:"${{ matrix.test_suite.target }}"

    - name: Cleanup
      if: always()
      run: |
        killall Simulator 2>/dev/null || true
        xcrun simctl shutdown "${{ steps.setup_simulator.outputs.simulator_udid }}" 2>/dev/null || true
        echo "✅ Cleanup completed"
